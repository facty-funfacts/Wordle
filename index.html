<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Abandoned Factory Shooter</title>
<style>
body { margin:0; background:#111; color:white; font-family:Arial; text-align:center;}
canvas { display:block; margin:0 auto; background:#222;}
#ui { margin:10px; font-size:18px;}
button { margin:5px; padding:10px 20px; font-size:16px;}
</style>
</head>
<body>
<h1>Abandoned Factory Shooter</h1>
<div id="ui">
  HP: <span id="hp">100</span> | Score: <span id="score">0</span> | Wave: <span id="wave">1</span> | Coins: <span id="coins">0</span>
</div>
<canvas id="gameCanvas" width="800" height="500"></canvas>
<div id="menu"></div>

<script>
// ===== GAME STATE =====
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let gameState = "playing"; // "playing", "gameover", "shop"

// ===== HUGE MAP =====
let map = {
  width:1600,
  height:1000,
  floorColor:"#A1866F",
  obstacles:[
    {x:0,y:0,w:1600,h:20,color:"#555"}, // top
    {x:0,y:980,w:1600,h:20,color:"#555"}, // bottom
    {x:0,y:0,w:20,h:1000,color:"#555"}, // left
    {x:1580,y:0,w:20,h:1000,color:"#555"}, // right
    // Pipes
    {x:200,y:100,w:20,h:150,color:"#4CAF50"},
    {x:400,y:250,w:150,h:20,color:"#4CAF50"},
    {x:600,y:400,w:20,h:200,color:"#4CAF50"},
    {x:1000,y:150,w:20,h:300,color:"#4CAF50"},
    {x:1300,y:500,w:250,h:20,color:"#4CAF50"},
    // Crates
    {x:300,y:600,w:60,h:60,color:"#8B5A2B"},
    {x:700,y:700,w:80,h:80,color:"#8B5A2B"},
    {x:1200,y:300,w:50,h:50,color:"#8B5A2B"},
    {x:1400,y:150,w:70,h:70,color:"#8B5A2B"},
    // Barrels
    {x:500,y:100,w:40,h:40,color:"#6B3E26"},
    {x:800,y:250,w:40,h:40,color:"#6B3E26"},
    {x:1100,y:600,w:50,h:50,color:"#6B3E26"},
    {x:1500,y:800,w:60,h:60,color:"#6B3E26"},
    // Debris
    {x:200,y:800,w:30,h:30,color:"#666"},
    {x:900,y:450,w:30,h:30,color:"#666"},
    {x:1300,y:700,w:40,h:40,color:"#666"},
    {x:1400,y:900,w:50,h:50,color:"#666"}
  ]
};

function drawPlayerSkin(player){
  let skin = skins[player.skin];
  let cx = player.x;
  let cy = player.y;
  let d = skin.diameter;

  // Face
  ctx.beginPath();
  ctx.arc(cx, cy, d/2, 0, Math.PI*2);
  ctx.fillStyle = skin.body;
  ctx.fill();
  ctx.closePath();

  // Optional details
  if(skin.detail=="scar"){
    ctx.strokeStyle="#FF0000";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(cx-d/6, cy-d/6);
    ctx.lineTo(cx+d/6, cy+d/6);
    ctx.stroke();
    ctx.closePath();
  }
  if(skin.detail=="blush"){
    ctx.fillStyle="#FFB6C1";
    ctx.beginPath();
    ctx.arc(cx-d/5, cy+d/8, 4, 0, Math.PI*2);
    ctx.arc(cx+d/5, cy+d/8, 4, 0, Math.PI*2);
    ctx.fill();
    ctx.closePath();
  }
  if(skin.detail=="freckles"){
    ctx.fillStyle="#8B4513";
    for(let i=0;i<5;i++){
      let fx = cx + (Math.random()-0.5)*d/2;
      let fy = cy + (Math.random()-0.5)*d/2;
      ctx.beginPath();
      ctx.arc(fx, fy, 2, 0, Math.PI*2);
      ctx.fill();
      ctx.closePath();
    }
  }

  // Eyes
  let eyeOffsetX = d/4;
  let eyeOffsetY = -d/8;
  let eyeRadius = d/8;
  ctx.beginPath();
  ctx.arc(cx-eyeOffsetX, cy+eyeOffsetY, eyeRadius, 0, Math.PI*2);
  ctx.fillStyle = skin.eye;
  ctx.fill();
  ctx.closePath();
  ctx.beginPath();
  ctx.arc(cx+eyeOffsetX, cy+eyeOffsetY, eyeRadius, 0, Math.PI*2);
  ctx.fillStyle = skin.eye;
  ctx.fill();
  ctx.closePath();

  // Pupils
  let pupilRadius = eyeRadius/2;
  ctx.beginPath();
  ctx.arc(cx-eyeOffsetX, cy+eyeOffsetY, pupilRadius, 0, Math.PI*2);
  ctx.fillStyle = skin.pupil;
  ctx.fill();
  ctx.closePath();
  ctx.beginPath();
  ctx.arc(cx+eyeOffsetX, cy+eyeOffsetY, pupilRadius, 0, Math.PI*2);
  ctx.fillStyle = skin.pupil;
  ctx.fill();
  ctx.closePath();

  // Smile / Frown
  ctx.beginPath();
  ctx.strokeStyle="#000000";
  ctx.lineWidth=2;
  let smileRadius = d/4;
  if(player.health>=50){
    ctx.arc(cx, cy+d/8, smileRadius, Math.PI/8, Math.PI-Math.PI/8, false); // smile
  } else {
    ctx.arc(cx, cy+d/4, smileRadius, Math.PI+Math.PI/8, 2*Math.PI-Math.PI/8, false); // frown
  }
  ctx.stroke();
  ctx.closePath();
}
  
let player = { 
  x: 400, 
  y: 400, 
  skin: "lime", 
  health: 100 
};
  
let skins = {
  lime:{body:"#32CD32",eye:"#FFFFFF",pupil:"#000000",diameter:40,detail:"default"},
  blue:{body:"#1E90FF",eye:"#FFFF00",pupil:"#000000",diameter:38,detail:"default"},
  red:{body:"#FF4500",eye:"#FFFFFF",pupil:"#000000",diameter:42,detail:"scar"},
  pink:{body:"#FF69B4",eye:"#FFFFFF",pupil:"#000000",diameter:40,detail:"blush"},
  gold:{body:"#FFD700",eye:"#000000",pupil:"#FFFFFF",diameter:41,detail:"freckles"}
};

let shopSkins = ["lime","blue","red","pink","gold"];
let unlockedSkins = ["lime"]; // start with lime unlocked
  
// ===== CONTROLS =====
let keys={};
document.addEventListener("keydown",e=>{keys[e.key]=true; updateShootDir(e.key,true)});
document.addEventListener("keyup",e=>{keys[e.key]=false;});

function updateShootDir(key,down){
  if(!down) return;
  if(key=="w") player.shootDir={x:0,y:-1};
  if(key=="s") player.shootDir={x:0,y:1};
  if(key=="a") player.shootDir={x:-1,y:0};
  if(key=="d") player.shootDir={x:1,y:0};
}

// ===== BULLETS =====
let bullets=[],enemyBullets=[];

// ===== COINS / SCORE / WAVE =====
let coins=0,score=0,wave=1,enemies=[],spawnTimer=0;

// ===== ENEMY TYPES =====
const enemyTypes={
  basic:{hp:20,speed:1.5,shootInterval:3000,points:1,color:"red"},
  fast:{hp:10,speed:3,shootInterval:4000,points:3,color:"cyan"},
  tank:{hp:40,speed:1,shootInterval:2000,points:5,color:"magenta"},
  boss:{hp:100,speed:1.2,shootInterval:1000,points:20,color:"purple"}
};

// ===== SPAWN ENEMY / WAVE =====
function spawnEnemy(type){
  let size=30,x=Math.random()*(map.width-size),y=-size;
  enemies.push({x,y,w:size,h:size,type,typeInfo:enemyTypes[type],hp:enemyTypes[type].hp,lastShot:0});
}
function spawnWave(){
  let basic=wave+2,fast=Math.floor(wave/2),tank=Math.floor(wave/3),boss=(wave%5==0)?1:0;
  for(let i=0;i<basic;i++) spawnEnemy("basic");
  for(let i=0;i<fast;i++) spawnEnemy("fast");
  for(let i=0;i<tank;i++) spawnEnemy("tank");
  if(boss) spawnEnemy("boss");
}

// ===== DRAW MAP =====
function drawMap(ctx){
  ctx.fillStyle=map.floorColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  map.obstacles.forEach(o=>{
    ctx.fillStyle=o.color;
    ctx.fillRect(o.x,o.y,o.w,o.h);
  });
}

// ===== PLAYER SHOOT =====
function shootPlayer(){
  if(!player.lastShot || Date.now()-player.lastShot>300){
    bullets.push({x:player.x+player.w/2-5,y:player.y+player.h/2-5,w:10,h:10,vx:player.shootDir.x*7,vy:player.shootDir.y*7});
    player.lastShot=Date.now();
  }
}

// ===== GAME OVER =====
function showGameOver(){
  gameState="gameover";
  const menu=document.getElementById("menu");
  menu.innerHTML=`<h2>GAME OVER</h2>
  <p>Score: ${score} | Coins: ${coins} | Wave: ${wave}</p>
  <button onclick="restartGame()">Restart</button>
  <button onclick="openShop()">Shop</button>`;
}

// ===== RESTART =====
function restartGame(){
  player.hp=player.maxHp;
  document.getElementById("hp").innerText=player.hp;
  bullets=[];enemyBullets=[];enemies=[];
  wave=1;spawnTimer=0;score=0;
  gameState="playing";
  document.getElementById("menu").innerHTML="";
  gameLoop();
}

// ===== SHOP =====
let shopSkins=["Lime","Blue","Red","Pink","Gold"];
function openShop(){
  gameState="shop";
  const menu=document.getElementById("menu");
  let html="<h2>SHOP</h2><p>Coins: "+coins+"</p>";
  shopSkins.forEach(skin=>{
    html+=`<button onclick="buySkin('${skin}')">${skin} skin - 50 coins</button>`;
  });
  html+=`<button onclick="closeShop()">Back</button>`;
  menu.innerHTML=html;
}
function buySkin(skin){
  if(coins>=50){coins-=50;player.skin=skin;document.getElementById("coins").innerText=coins;alert("Skin purchased!");}
  else alert("Not enough coins!");
}
function closeShop(){document.getElementById("menu").innerHTML="";gameState="playing";gameLoop();}

// ===== GAME LOOP =====
function gameLoop(){
  if(gameState!="playing") return;

  // Move player
  if(keys["ArrowUp"]) player.y-=player.speed;
  if(keys["ArrowDown"]) player.y+=player.speed;
  if(keys["ArrowLeft"]) player.x-=player.speed;
  if(keys["ArrowRight"]) player.x+=player.speed;

  // Shoot
  if(player.shootDir.x!=0 || player.shootDir.y!=0) shootPlayer();

  // Spawn enemies
  spawnTimer++;
  if(spawnTimer>200){spawnWave();spawnTimer=0;}

  // Update bullets
  bullets.forEach((b,i)=>{b.x+=b.vx;b.y+=b.vy;if(b.x<0||b.x>map.width||b.y<0||b.y>map.height) bullets.splice(i,1);});
  enemyBullets.forEach((b,i)=>{b.x+=b.vx;b.y+=b.vy;if(b.x<0||b.x>map.width||b.y<0||b.y>map.height) enemyBullets.splice(i,1);});

  // Update enemies
  enemies.forEach((e,ei)=>{
    let dx=(player.x+player.w/2)-(e.x+e.w/2);
    let dy=(player.y+player.h/2)-(e.y+e.h/2);
    let dist=Math.hypot(dx,dy);
    e.x+=(dx/dist)*e.typeInfo.speed;
    e.y+=(dy/dist)*e.typeInfo.speed;

    if(!e.lastShot || Date.now()-e.lastShot>e.typeInfo.shootInterval){
      let dxp=(player.x+player.w/2)-(e.x+e.w/2);
      let dyp=(player.y+player.h/2)-(e.y+e.h/2);
      let mag=Math.hypot(dxp,dyp);
      enemyBullets.push({x:e.x+e.w/2-5,y:e.y+e.h/2-5,w:10,h:10,vx:dxp/mag*4,vy:dyp/mag*4});
      e.lastShot=Date.now();
    }

    bullets.forEach((b,bi)=>{
      if(b.x<b.x+b.w && b.x+b.w>e.x && b.y<b.y+b.h && b.y+b.h>e.y){
        e.hp-=10; bullets.splice(bi,1);
        if(e.hp<=0){coins+=1;score+=e.typeInfo.points;enemies.splice(ei,1);}
      }
    });

    if(player.x<e.x+e.w && player.x+player.w>e.x && player.y<e.y+e.h && player.y+player.h>e.y){
      player.hp-=20;document.getElementById("hp").innerText=player.health;enemies.splice(ei,1);
    }
  });

  // Enemy bullets hit player
  enemyBullets.forEach((b,bi)=>{
    if(player.x<b.x+b.w && player.x+player.w>b.x && player.y<b.y+b.h && player.y+player.h>b.y){
      player.health-=10;document.getElementById("hp").innerText=player.hp;enemyBullets.splice(bi,1);
    }
  });

  // Game over
  if(player.health<=0){showGameOver();return;}

  // UI
  document.getElementById("score").innerText=score;
  document.getElementById("coins").innerText=coins;
  document.getElementById("wave").innerText=wave;

  // Draw map + everything
  drawMap(ctx);

  // Bullets
  ctx.fillStyle="yellow"; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

  // Enemy bullets
  ctx.fillStyle="orange"; enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

  // Enemies
  enemies.forEach(e=>{ctx.fillStyle=e.typeInfo.color;ctx.fillRect(e.x,e.y,e.w,e.h);});

  requestAnimationFrame(gameLoop);
}

// ===== START =====
gameLoop();
</script>
</body>
</html>
